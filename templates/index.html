{% extends "base.html" %}
{% macro tile(title, id) -%}
<div class="row"><div class="twelve columns" ><div id="{{ id }}" class="panel">
<h2>{{ title }}</h2>
{{ caller() }}
<br>
</div></div></div>
{%- endmacro %}
{% block extrahead %}
<script type="text/javascript" src="/static/js/d3.min.js"></script>
<script type="text/javascript" src="/static/js/d3.geom.min.js"></script>
<script type="text/javascript" src="/static/js/d3.layout.min.js"></script>
<script type="text/javascript">

var NodeClass = function(x, y) {
    this.x = x;
    this.y = y;
    this.contacts = [];
    this.newbie = true;
}

var w = 420,
    h = 380,
    k = 4,
    chance = 0.08,
    nodes = [],
    links = [],
    colors = d3.scale.linear().domain([1, k]).range(
        ["hsl(350, 50%, 50%)", "hsl(250, 100%, 50%)"]
        ).interpolate(d3.interpolateHsl);
;

var root_node = new NodeClass(w/2, h/2);
nodes.push(root_node);

$(function() {

var vis = d3.select(".hull").append("svg:svg")
    .attr("width", w)
    .attr("height", h);
/*
vis.append("svg:rect")
    .attr("width", w)
    .attr("height", h);
*/
var force = d3.layout.force()
    .nodes(nodes)
    .links(links)
    .linkDistance(7)
    .size([w, h]);

var cursor = vis.append("svg:circle")
    .attr("r", 30)
    .attr("transform", "translate(-100,-100)")
    .attr("class", "cursor");

force.on("tick", function() {
  vis.selectAll("line.link")
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  vis.selectAll("circle.node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .filter(function(d) { return ! d.newbie; })
      .attr("fill", function(d) { return colors(d.contacts.length); });
});

vis.on("mousemove", function() {
//  cursor.attr("transform", "translate(" + d3.svg.mouse(this) + ")");
});

function new_node() {
  var node = new NodeClass(Math.random() * w, Math.random() * h),
      shufd = _.shuffle(nodes);

  // add links to any nearby nodes
  for (var i = 0; i < shufd.length; i++) {
    var target = shufd[i];
//    console.log(target);
    if (target.contacts.length < k) {
      links.push({source: node, target: target});
      target.contacts.push(node);
      break;
    }
  }
  nodes.push(node);
  restart();
}

function new_nodesss() {
    var n = Math.ceil(Math.log(nodes.length));
    console.log(n);
    if (n <= 0) { n = 1; };
    for (;n>0;n--) {
        new_node();
    }
}

function new_node_2() {
  var newnodes = [];
  for (var i = 0; i < nodes.length; i++) {
    var target = nodes[i];
    var ratio = target.contacts.length / k; //(target.contacts.length == 0)
    var n = 1 - ratio;
    if (target.contacts.length < k && ((n * Math.random()) <= chance)) {
      var node = new NodeClass(
        target.x + (Math.random() - 0.5) * 10,
        target.y + (Math.random() - 0.5) * 10
      );
      links.push({source: node, target: target});
      target.contacts.push(node);
      node.contacts.push(target);
      newnodes.push(node);
    }
  }
  _.each(newnodes, function(n){ nodes.push(n);});
  restart();
  return newnodes;
}

function runloop() {
//    window.setTimeout(runloop, 1000);
    var newnodes;
    while (true) {
        newnodes = new_node_2();
        var count = newnodes.length;
        if (count > 0) {
            console.log(count);
            break;
        }
    };

}

//runloop();
//vis.on("mousedown", new_nodesss);
vis.on("mousedown", runloop);


restart();

function restart() {

  vis.selectAll("line.link")
      .data(links)
    .enter().insert("svg:line", "circle.node")
      .attr("class", "link")
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  vis.selectAll("circle.node")
      .data(nodes)
    .enter().insert("svg:circle", "circle.cursor")
      .attr("class", "node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", 5)
      .attr("fill", "yellow")
      .call(force.drag)
    .transition()
      .duration(150)
      .attr("fill", function(d) { return colors(d.contacts.length); })
      .each("end", function(d) {
        d.newbie = false;
      });

  force.start();
}

});
</script>
<style type="text/css">

.hull {
    border: solid 1px black;
}

rect {
  fill: #fff;
}

.node {
}

.cursor {
  fill: none;
  stroke: brown;
  pointer-events: none;
}

.link {
  stroke: #222;
}

</style>
{% endblock %}
{% block content %}

{% call tile("How It Works", "how") %}
<p>The Dendrite Network works by...
{% endcall %}

{% call tile("Network Spread", "demograph") %}
    <div class="hull"></div>
{% endcall %}

{% call tile("Your URL", "ownurl") %}
<p>If you want to participate directly in the network you must pick an
URL to represent yourself.  It can be any URL but if you want to be
contacted then it should obviously include some way of contacting you.
<p>Obvious candidates for avatar URLs would be your facebook or twitter
pages, your blog, your personal homepage, or a specific page you made to
use with the Dendrite Network.
<p>If you aren't concerned about being contacted then you can use a page
from the Wikipedia or something.
<p>(An important point to keep in mind concerning the Dendrite Network is
that you will generally only ever be exchanging memes with people you
know.
<p>All the people in your contacts should be known to you, and you
normally won't exchange information with unknown users.)

<hr>
<h4>Enter an URL</h4>
<form class="nice" method="POST" action="{{ register }}">
  <center>
  <input id="urly" type="text" name="urly" maxlength="100" placeholder="http://" />
  </center>
  <br/>
  <input type="submit" value="Use this URL to represent me."/>
</form>
{% endcall %}

{% call tile("More...", "enfriendly") %}
<div class="row">
<div class="seven columns" >
  <a href="http://firequery.blogspot.com/">Read my blog for more info</a> or follow me on Twitter &gt;&gt;
</div>
<div class="five columns" >
  <center>
    <a href="https://twitter.com/SimonForman" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @SimonForman</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="http://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </center>
</div>
</div>
{% endcall %}
{% endblock %}

